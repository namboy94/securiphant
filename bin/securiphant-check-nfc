"""LICENSE
Copyright 2019 Hermann Krumrey <hermann@krumreyh.com>

This file is part of securiphant.
LICENSE"""

from securiphant.crypto import verify_password
from securiphant.nfc import read_nfc_data
from securiphant.config import load_config
from securiphant.db import uri
from securiphant.db.states.BooleanState import BooleanState
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker


def main():
    """
    This script checks whether the NFC reader reads an authenticated NFC tag
    If a authenticated tag is held against the sensor, the value

    is_authenticated

    is set to True in the shared database

    :return: None
    """
    # TODO Work through this: https://pimylifeup.com/raspberry-pi-rfid-rc522/

    engine = create_engine(uri)
    _sessionmaker = sessionmaker(bind=engine)

    while True:

        key = read_nfc_data()
        _hash = load_config()["nfc_hash"]

        if verify_password(key, _hash):
            session = _sessionmaker()
            user_authorized = session.query(BooleanState)\
                .filter_by(key="user_authorized").first()

            user_authorized.value = not user_authorized.value
            session.commit()


if __name__ == "__main__":
    main()
